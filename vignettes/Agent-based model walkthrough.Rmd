---
title: "Agent-based model walkthrough"
author: "Benjamin Michael Marshall"
date: '2022-03-02'
output:
  bookdown::html_document2:
    theme: yeti
    highlight: monochrome
    # css: system.file("extdata", "style.css", package = "abmAnimalMovement")
    css: styleOverwrite.css
    fig_caption: true
vignette: |
  %\VignetteIndexEntry{walkthrough} %\VignetteEngine{knitr::rmarkdown} %\VignetteEncoding{UTF-8}
link-citations: yes
linkcolor: blue
bibliography: abmAnimalMovement_refs.bib
biblio-style: peerj
---

# Introduction

## Rationale

- justify studying movement - conservation + core ecology questions

As the biodiversity crisis deepens, we are in constant need of new refined methods of mitigating human impacts on animals.
Developing mitigation strategies is aided by a strong understanding of animals lives and needs.
How animals move offers a window into their decisions making process <!-- paper on bifrufacted choice here I think -->, as well as how they prioritise resources, avoid threats, and react to anthropogenic modification of the environment.
Examinations of animal movement are frequently integrated into conservation plans <!-- fraser et al paper here --> because of the insights they provide on habitat and space requirements; but also offer avenues to explore fundamental question about ecology. For example, <!-- example, trade-off between size energy and space use? -->.

- therefore we need studies to be more ethical and cost effective - key in conservation

The information gathered from animal movement studies is only as robust as the methods and analysis applied.
In the past <!-- "## years", look at the great Joo et al review --> the volume of animal data has exploded, but the analysis approaches to extract maximum information have lagged behind.
The often conservation sensitivity of studies animals, as well as the bodily cost of attaching bio-telemetry devices, means we have an ethical duty to maximise the values/impact of the data collected. <!-- poss the public funding origin of research too-->

- fix methods now because of replication issues?

Meta-analyses have revealed that several textbook examples in ecology are not as universally replicable as once thought.
Whereas lab studies can more feasibly be repeated (although such replications are far from cheap), movement studies conducted on free-ranging wild animals are difficult to repeat while satisfactorily meeting the conditions of the true replication. <!-- likely need to add something defining true replication here -->
<!-- maybe new para here then -->
It is hard to justify placed bio-telemetry devices on more animals to repeat a study, especially when they are of conservation concern.
As we have limited scope for repeating wild movement studies, it is imperative that we maximise the quality of the initial studies.

- power-analysis-esk things and planning are the way to reduce costs and minimise neg impacts
- examples of virtual ecology being a valid approach <!-- https://www.biorxiv.org/content/10.1101/2022.03.20.485041v1.full.pdf+html possible example vrey new -->

Expanding pre-study planning and developing better approaches to guide study design may provide a partial solution.
Study scenarios where researchers have great control over the environment, randomisation, and controls satisfy the assumptions of many statistical approaches.
Movement studies conducted in the wild are fraught with uncontrollable confounding variables and often further restricted by sample sizes limited by ethics, capture rates, and cost of bio-telemetry equipment.
As the complexity of the research environment increases so must the analysis approach to account for the uncontrollable, but potentially extraneous to the question variables.
Testing these analysis approaches, and their limitations therefore becomes more difficult to asses a priori.

A potential solution is virtual ecology: where synthetic data is simulated to cover a range of possible scenarios allowing researchers to explore different study approaches/designs with the aim of identifying the best for a given question.
<!-- examples of virtual ecology here -->

- example of SECR improvements because of it

Population monitoring studies offer us a great example of a mature relationship between simulated data, study design, and applied research, implemented in a complex study environment.
<!-- deep dive of the SECR world, and the papers that have used sims to prove approaches -->

- agent-based supplements existing simulation efforts
- agent-based good way to capture complexities of animal movement

As demonstrated by the SECR example, different simulation approaches and different analyses accounting for different additional complexities offer different suggestions on the optimal study design.
There have been prior efforts to simulate animal movement: <!-- ctmm, moveHMM, that recent paper, the C based one for rivers-->, all with different aspects of animal movement included.
Here we present an agent-based approach to supplement those.
The agent-based approach is well suited to explore a combination of the (not fully understood) complexities of animal movement, and the emergent properties.
Our model requires no prior movement data, allows for multiple predefined points of attraction/avoidance, two-levels of activity cycling, three behavioural states, and multiple spatial environmental covariates.
A new independently developed approach to simulating animal movement will provide a additional routes to test the robustness of movement analyses.

## The agent-based model

- time step
- basic workings of simulation
- behavioural state
- movement vs decisions and attraction points
- cycling

The abmAnimalMovement package provides functionality to simulate animal movements via an agent-based model.
The model aims simulates animal locations over a given period of time at discrete time steps.
At each time step the agent (i.e., simulated animal) is presented with a range of movement options in the form of new locations, and will chose from amongst these.
The possible movement options, and how the new location is selected, are influenced by several factors: behavioural state of the animal, environmental quality, and proximity to points of attraction/avoidance.

The animal has three behavioural states, broadly defined as resting (or sheltering), exploring, and foraging. 
Each behavioural state modifies the movement characteristics of the animal; for example, exploring comprises of more random movements with longer distances between points, whereas resting behaviour is largely defined by stationary or very low discrete movements.
On top of the movement characteristics, the behavioural state defines what environmental layer (supplied to the model as a raster) is used govern the choice of subsequent animal locations. For example, foraging movement choices will be weighted towards areas of increased resources if the animal is in the foraging behavioural mode.

The movement choices of the animal are also influenced by a movement resistance raster.
Differing values represent different environmental conditions that could change how easily/likely an animal is to use that area to move towards a destination.
For example, rivers or hard barriers within a landscape could present very high movement resistance and a animal would aim to avoid traversing them.
Alternatively areas of lower movement resistance could aid movement, and potentially form movement corridors.

Animals often occupy steady areas, or home ranges.
Home ranges are mean to represent areas in which the animal can source all resources required for a given life stage.
We can simulate the existence of home ranges using a point (or points) of attraction, an approach which has reoccurred in movement and population ecology studies.
In the abmAnimalMovement model, we have simulated a number of points of attraction to differing resources in an attempt to simulate a home range with unequal and behavioural influenced spatial use.
The modelled animal is provided with a number of shelter sites that serve as points of attraction when in the resting behaviour.
The predefined and steady state of these shelter sites provides the stability we look for in a home range, as well as a means of predefining a level of site fidelity.
Additionally, the model allows the animal to randomly select (but weighted towards areas of higher quality) a foraging destination as a point of attraction when in the foraging behavioural mode.
Importantly the dynamic nature of the foraging destination selection allows for it to operate on a different time frame to the movement selection.
The two time frames allow for explorations of assumptions connecting observed movement choices to choices regarding resources.
We know that movements cannot be directly translated to animal preference, so the simulation required a mechanism that somewhat detaches the preference/choice for observed movements.

The interplay between shelter sites and foraging quality attractors simulates the site fidelity required for home ranges, while allowing the environment (in the form of a raster describing resource quality) to help shape the size and diffusion of that home range.
Multiple attractors that apply at different times and result in different movements can be missed in simulations that assume uniform circular animal space use.
Simulating a more dynamic and messy array of movements can help test how far assumptions of uniform circular animal movement are useful.

The attractor and movement characteristics are impacted by the behavioural state of the animal, and that behavioural state has a chance of changing at each time step.
However, the changes should not be fully random nor have equal chance at each time step.
Therefore, the model allows for a predefined cycle that influences the chances of switching in and out of the resting behavioural state.
As such we have a means of simulating an animal with a given diel cycle, be that nocturnal, crepuscular, or anything in between.

# Generating three species {#intro .colorful}

The best way to demonstrate the variation that movement ecology methods needs to wrangle, as well as the scope of movements the agent-based model can recreate, we provide three example species.
The examples cover a range of movement capacities, site fidelity, and resting/sheltering patterns. 
None of the created examples are meant to directly match previously collected data on the species movements –there are alternative methods built to fit and simulate movements from existing data– instead the examples provide some biological context to demonstrate a range of simulation parametrisations.

## Badger - High site fidelity

Badger occupy a sett, a single home/shelter site, that they routinely return to.
When not at the sett the badger forages, and the foraging distances are impacted by resource position <!-- 10.1111/j.1469-7998.1999.tb01015.x might help --> and movement capacity of the badger (i.e., how far can a badger feasibly travel for food from the sett).
The badger therefore expresses very high site fidelity, a range dictated by the spatial positioning of resources, and is subject to the movement resistance of the terrestrial environment.

Badger movements are also impacted by their territoriality. 
While the simulation does not attempted to simulate territoriality directly via competing simultaneously simulated badgers, we can approximate territoriality by providing a number of distant avoidance points.

Badger occupying temperate areas are impacted by seasonal shifts that modify daylight hours and available resources. The model allows for a second cycle that can modify the resting behaviour on top of the baseline diel resting cycle. In this example we will allow the cycle to increase the intensity of resting behaviour during a portion of the year, while retaining a relatively stable diel cycle (i.e., badger will sleep longer during one part of the year). A more extreme implementation of the second cycle could introduce hibernation behaviour.

## Vulture - High movement variation

Unlike badgers and other terrestrially moving animals, vultures can move great distances with minimal obstruction.

- Explore behaviour should be circular

## King Cobra - High resting variability

Whereas the previous two species have a very limited or single shelter sites, king cobras make use of a wider range of shelter sites distributed more widely over their home ranges.
What more dramatically sets king cobras, and other snakes, apart is a vastly differing rest-forage cycle.
While they still exhibit a diel cycle, the intermittent depredation of large prey items and the time required sheltering to digest large meals results in a second broader activity cycle operating over a more widely observed diel cycle.
The agent-based model allows for two cycles to be input, one that will describe the daily activity cycle, and a second that describes the foraging and digestion cycle. Unlike the badger's secondary cycle the forage digestion cycle is stable throughout the year and operates on a much shorter time frame.


# Required libraries

```{r libraries, include=TRUE, warning=FALSE, message=FALSE}
library(abmAnimalMovement)
library(ggplot2)
library(reshape2)
library(patchwork)
library(scico)
library(dplyr)
```

# Setting a palette and seed

Before running the simulation and reviewing the outputs we need to set a few constants to ensure that the outputs are reproducible.
First, we set a palette to drawn from for later figures that takes the form of a named vector.
For now five colours will be adequate to cover our later plotting needs.
As we are about to run a simulation with three behavioural states –coded as 2, 1, and 0– we will name three corresponding colours in the vector as such.
This way we can ensure a consistent colour coding for our behavioural states across multiple visualisations [Figure \@ref(fig:palettePreview)].

```{r definePalette, include=TRUE}
palette <- c("#AD6DED", "#7D26D4", "#E87D13", "#965A1D", "#302010")
names(palette) <- c("purp1", "purp2", "2", "1", "0")
```

```{r palettePreview, echo=FALSE, eval=TRUE, fig.align='center', fig.width=5, fig.height=2.5, fig.cap="Preview of the palette colours selected and stored for later use. Name assigned to the colour in bold, and the hex code in italics below."}

data.frame(
  names = names(palette),
  hexcodes = palette
) %>% 
  ggplot() +
  geom_col(
    aes(x = names, y = 1, fill = names)
  ) +
  geom_text(
    aes(x = names, y = 0.5, label = names),
    vjust = 0.5, hjust = 0.5, colour = "white",
    fontface = 2, size = 7
  ) +
  geom_text(
    aes(x = names, y = 0.4, label = hexcodes),
    vjust = 1, hjust = 0.5, colour = "white",
    fontface = 3, size = 3
  ) +
  scale_x_discrete(position = "top") +
  scale_fill_manual(values = palette) +
  theme_void() +
  theme(legend.position = "none")

```
To ensure that the simulation completed during the vignette is repeatable, we set a seed.
For the sake of simplicity the year the vignette was written –2022– is used.

```{r defineSeed, include=TRUE}
set.seed(2022)
```

# Generating environmental rasters

Before starting to simulate animal movement we need to generate a landscape.
The landscapes in this case will take the form of rasters, where each cell is describing the quality of foraging, shelter, and movement ease. 
The highest quality locations/cells are coded as 1, with quality decreasing as the values range down to 0.
The 1 to 0 quality values in each cell are later used to help the animal to chose how and where it moves throughout the landscape.
Depending on the behavioural state the weighing of which raster layers used will change (e.g., when in a resting behavioural state the shelter site quality layer is used).

To generate each layer we use the NLMR package (neutral landscape models), and combine a selection of landscape generation methods with landscapetools [@Sciaini2018].

- foraging
- shelter
- movement

- add 3d raster display

# Defining the behaviroual states

## Parameterising the movement distributions

As mentioned, we are running a simulation with three behavioural states: 0 - rest, 1 - explore, 2 - forage.
Each behavioural state comprises to two distributions: a Gamma distribution that step lengths are drawn from, and a Von-Mises that turn angles are drawn from.
The resulting step length, combined with a turn angle describes the change in animal location between each time step.

## Creating behavioural transition matrix

As the simulation will be running with three behavioural states, we need to define how likely an animal is to switch between the behaviours.

## Defining the rest cycle

- cycle parameters cos waves stuff

# Parameterising simulation

We need to initially define a start location for our animal.
To introduce some more individual variation we can randomly vary this starting location, but we will restrict the start locations to be proximal to the centre of the environment.
For the simulation we need a vector of length 2, where the first value is the x location, the second is y.

```{r defineStart, include=TRUE}
startLocation <- sample(900:1100, 2, replace = TRUE)
```

- length of time
- number of choices
- destinations
- inputting the rest of the predefined stuff

# Reviewing observed movements

## Step lengths

## Turning angles

# Mapping movements

- would be nice to have a faceted plot, where column one are rasters with attraction points, and column two are the observed movements, each row is each behavioural state highlight (other points are greyed out)

# Reviewing behavioural state cycling

# Testing sampling function

# Testing Von-Mises function

[@Tang2010]

